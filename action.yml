name: 'Test AWS'
description: 'Test AWS'
inputs:
  environment:
    description: 'environment - used to switch'
    required: true
  aws_access_key:  # id of input
    description: 'aws_access_key'
    required: true
  aws_secret_access_key:
    description: 'aws_secret_access_key'
    required: true
  patchVersion:
    description: "version to patch"
    required: true
  task_definition_name:
    description: "name of the task definition"
    required: true
  aws_region:
    description: "usually us-east-1"
    required: true
  image:
    description: "image id"
    required: true
  container_name:
    description: "container name"
    required: true
  service:
    description: "service"
    required: true
  cluster:
    description: "cluster name"
    required: true
  INFRABOT_GITHUB_TOKEN:
    description: "for slack"
    required: true
  destination_folder:
    description: "where to put the manifest in the infra repo"
    required: true

runs:
  using: "composite"
  steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ inputs.aws_access_key }}
        aws-secret-access-key: ${{ inputs.aws_secret_access_key }}
        aws-region: ${{ inputs.aws_region }}
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1
    - name: Log the new image ID that will go into the Amazon ECS task definition
      shell: bash
      run: |
        echo "Patch version: ${{ inputs.patchVersion }}"
        echo "into env ${{ inputs.environment }}"
    - name: Download task definition - and excise env vars
      id: task-definition-download
      shell: bash
      run: |
        echo "${{ inputs.task_definition_name }}"
        taskDefinition="${{ inputs.task_definition_name }}"
        aws ecs describe-task-definition --task-definition ${taskDefinition} --query taskDefinition > TaskDefinition.json
        # then remove env vars
        aws ecs describe-task-definition --task-definition ${taskDefinition} --query taskDefinition | jq 'del(.containerDefinitions[0].environment)' | jq 'del(.containerDefinitions[1].environment)' > tempTaskDefinition.json
      - name: Fill in the new image ID in the Amazon ECS task definition
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: TaskDefinition.json
          container-name: ${{ inputs.container_name }}
          image: ${{ inputs.image }}
      # - name: Deploy Amazon ECS task definition
      #   uses: aws-actions/amazon-ecs-deploy-task-definition@v1
      #   with:
      #     task-definition: ${{ steps.task-def.outputs.task-definition }}
      #     service: ${{ inputs.service_name }}
      #     cluster: ${{ inputs.cluster_name }}
      - name: Pushes task definition file to infra repo
        uses: dmnemec/copy_file_to_another_repo_action@main
        env:
          API_TOKEN_GITHUB: ${{ inputs.INFRABOT_GITHUB_TOKEN }}
        with:
          source_file: 'tempTaskDefinition.json'
          user_email: 'paul@lonsdaleinvest.com'
          user_name: 'pk-lit'
          destination_repo: 'lonsdaledm/infra'
          destination_folder: ${{ inputs.destination_folder }}

# name: 'Hello World'
# description: 'Greet someone'
# inputs:
#   who-to-greet:  # id of input
#     description: 'Who to greet'
#     required: true
#     default: 'World'
# outputs:
#   random-number:
#     description: "Random number"
#     value: ${{ steps.random-number-generator.outputs.random-number }}
# runs:
#   using: "composite"
#   steps:
#     - run: echo Hello ${{ inputs.who-to-greet }}.
#       shell: bash
#     - id: random-number-generator
#       run: echo "::set-output name=random-number::$(echo $RANDOM)"
#       shell: bash
#     - run: echo "${{ github.action_path }}" >> $GITHUB_PATH
#       shell: bash          
#     - run: goodbye.sh
#       shell: bash
